# 模拟退火

### 一、核心思想：来自物理世界的智慧——金属退火

想象一下你是一位铁匠，要锻造一把绝世宝剑。为了让剑身内部的晶体结构最稳定、最完美（也就是能量最低），你会怎么做？

1. **升温**：首先，你会把金属块加热到极高的温度，甚至接近熔化的状态。这时，金属内部的原子获得了巨大的能量，可以自由地、剧烈地到处移动，摆脱原来的束缚。
2. **缓慢冷却（退火）**：然后，你不会把它直接扔进冷水里（那是“淬火”），而是会非常、非常缓慢地降低温度。
   - 在**高温**时，原子依然很活跃，有足够的能量跳出当前的局部最优结构，去探索其他可能的位置。
   - 随着温度**逐渐降低**，原子的活动能力变弱。它们会倾向于移动到能量更低的位置，并慢慢稳定下来。因为冷却过程足够慢，它们有充分的时间找到全局能量最低的、最完美的晶格结构。

### 二、模拟退火与优化问题的类比

我们把优化问题和退火过程对应起来：

- **解 (Solution)**：金属内部的一种原子排列状态。
- **目标函数/成本函数 (Cost Function)**：该状态的**能量 (Energy)**。我们的目标是找到能量最低的状态，也就是**最优解**。
- **温度 (Temperature, T)**：一个控制参数。它从一个很高的初始值开始，然后**缓慢下降**。
- **从一个解移动到另一个解**：原子从一个位置跳到另一个位置。

### 三、核心机制：如何“跳出”局部最优？

很多传统的优化算法（比如爬山算法）都有一个致命弱点：它们只会朝着“更好”的方向走。这就像一个只能下山的盲人，他很容易走到一个小山谷（局部最优解）就卡住了，以为自己到了最低点，却不知道旁边还有一个更深的海沟（全局最优解）。

模拟退火的精妙之处在于它的**接受准则 (Acceptance Criterion)**：

1. **找到一个新解**：从当前解 S_current 出发，随机产生一个邻近的新解 S_new。

2. **计算能量差**：计算新解和当前解的“能量差” ΔE = E(S_new) - E(S_current)。

3. **做出决策**：

   - **如果新解更好 (ΔE < 0)**：这意味着新解的能量更低（成本更小），我们**总是接受**这个新解。这就像爬山算法一样，总是走向更好的方向。

   - **如果新解更差 (ΔE > 0)**：这才是关键！我们**不立即拒绝**，而是以一个**概率 P** 来接受这个“坏”的移动。这个概率由著名的 **Metropolis 准则**给出：

     P = exp(-ΔE / T)

这个公式非常巧妙：

- **与 ΔE 的关系**：新解比当前解差得越多（ΔE 越大），接受它的概率 P 就越小。这是理所当然的，我们不想轻易接受一个非常糟糕的解。
- **与温度 T 的关系**：
  - **当 T 很高时**（退火初期），P 的值会比较大。这意味着算法有很大概率接受一个“坏”的移动，使其有能力“翻过小山”，去探索更广阔的解空间，避免陷入局部最优。
  - **当 T 很低时**（退火末期），P 的值会趋近于0。这意味着算法几乎不再接受“坏”的移动，它会稳定在当前找到的较优解区域内进行精细搜索。

这个“在高温时勇于探索，在低温时精于挖掘”的特性，就是模拟退火算法的灵魂。

### 四、算法执行步骤

1. **初始化**：
   - 随机生成一个初始解 S_current。
   - 设置一个足够高的初始温度 T_initial。
   - 设置一个终止温度 T_final 和一个降温速率 α (一个略小于1的数，如0.99)。
   - 记录下目前找到的最优解 S_best = S_current。
2. **外循环（降温）**：当 T > T_final 时，重复以下步骤：
   a. **内循环（在当前温度下迭代）**：重复 L 次（比如100次）：
   i. 从当前解 S_current 产生一个邻近的新解 S_new。
   ii. 计算能量差 ΔE。
   iii. 如果 ΔE < 0，则接受新解：S_current = S_new。
   iv. 如果 ΔE > 0，则根据概率 P = exp(-ΔE / T) 决定是否接受新解。
   v. 更新全局最优解：如果当前的 S_current 比 S_best 更好，则 S_best = S_current。
   b. **降温**：T = T * α。
3. **结束**：循环结束后，S_best 就是我们找到的近似最优解。